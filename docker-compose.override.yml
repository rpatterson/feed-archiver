# Override `$ docker compose ...` configuration for development or testing here in this
# repo checkout.  Everything that may be used outside this checkout should be in
# `./docker-compose.yml`.
version: "3.8"

services:

  ## Configuration specific to this checkout
  feed-archiver:
    image: "merpatterson/feed-archiver:local"
    build: "./"
    # Allow use in development checkout alongside a real deployment, avoid name clash
    container_name: "feed-archiver-devel"
    depends_on:
      # Don't force service dependencies on other deployments that extend the base
      - "ofelia"
      - "sonarr"
    volumes:
      # Preserve caches caches between container runs
      - "./home/:/home/feed-archiver/"
      # Specify the default archive within your media library
      - "${FEED_ARCHIVE:-/media/Library/feeds/}:${FEED_ARCHIVE:-/media/Library/feeds/}"

  # Allow use in development checkout alongside a real deployment, avoid name clash
  sonarr:
    container_name: "feed-archiver-devel-sonarr"
    # Choose a port prefix unlikely to be in use from the ephemeral port range
    # https://en.wikipedia.org/wiki/Ephemeral_port#Range
    #     $ shuf -i 49-65 -n 1
    #     54
    ports:
      - "8989:54989"
  traefik:
    container_name: "feed-archiver-devel-traefik"
  nginx:
    container_name: "feed-archiver-devel-nginx"
  ofelia:
    container_name: "feed-archiver-devel-ofelia"

  ## Container for use by developers
  feed-archiver-devel:
    image: "merpatterson/feed-archiver:devel"
    build:
      context: "./"
      dockerfile: "./Dockerfile.devel"
    environment:
      # Make the run-time user configurable in `./.env`
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-100}"
    volumes:
      # Ensure local changes are reflected inside the container.
      - "./:/usr/local/src/feed-archiver/"
      # Preserve caches caches between container runs
      - "./home/:/home/feed-archiver/"
      # Ensure access permissions to build artifacts inside docker.
      # If created by `# dockerd`, it ends up owned by `root`.
      - "./var-docker/:/usr/local/src/feed-archiver/var/"
      - "./.tox-docker/:/usr/local/src/feed-archiver/.tox/"
      - "./src/feed_archiver-docker.egg-info/:/usr/local/src/feed-archiver/src/feed_archiver.egg-info/"

  ## Contianers used during release

  pandoc:
    image: "pandoc/core"
    user: "${PUID:-1000}:-100}"
    volumes:
      - "./:/data/"
    command: >-
      "./README.rst" -f "rst" -t "markdown" -o "./README.md"

  docker-pushrm:
    image: "chko/docker-pushrm"
    depends_on:
      - "pandoc"
    environment:
      DOCKER_USER: "${DOCKER_USER:-merpatterson}"
      DOCKER_PASS: "${DOCKER_PASS}"
    volumes:
      - "./:/data/"
    command: >-
      --file "/data/README.md" --short "feed archiver foundation or template"
      --debug "merpatterson/feed-archiver"

  ## Container for use by end users
  dind:
    image: "docker:dind"
    privileged: true
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
      - "./:/usr/local/src/feed-archiver/"
      - "./var-dind/:/usr/local/src/feed-archiver/var/"
      - "./.tox-dind/:/usr/local/src/feed-archiver/.tox/"
    working_dir: "/usr/local/src/feed-archiver/"

  gitlab-release-cli:
    image: "registry.gitlab.com/gitlab-org/release-cli:latest"
    environment:
      CI_JOB_TOKEN: "${CI_JOB_TOKEN:-}"
    volumes:
      - "./:/usr/local/src/feed-archiver/"
    working_dir: "/usr/local/src/feed-archiver/"
